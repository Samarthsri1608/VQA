<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Safety Vision</title>
  <link rel="preload" href="/static/css/theme.css" as="style">
  <link rel="stylesheet" href="/static/css/theme.css">
  <link rel="stylesheet" href="/static/css/app.css">
  <script defer src="/static/js/app.js"></script>
</head>
</head>
<body>

<header class="site-header">
  <img src="/static/img/logo.svg" alt="Safety Vision" class="site-logo">
  <div style="flex:1"></div>
  <nav>
    <a class="button" href="/auth/logout">Logout</a>
  </nav>
</header>

<div class="container">

  <div class="grid">
    <!-- Left: Upload & Detection -->
    <div class="card">
      <h3>1) Upload Image & Detect</h3>
      <input id="imgInput" type="file" accept="image/*"/>
      <button id="btnDetect">Run Analysis</button>
      <h3>Detections</h3>
      <div id="detList">—</div>
      <h3>Annotated Image</h3>
      <img id="annotated" alt="Annotated result"/>
    </div>

    <!-- Right: Results -->
    <div class="card">
      <h3>Results</h3>

      <h3>Wrong</h3>
      <div id="wrongSection"></div>

      <h3>Right</h3>
      <div id="rightSection"></div>

      <h3>What To Do</h3>
      <div id="todoSection"></div>
    </div>
  </div>
  <div style="text-align:center; margin-top:20px;">
    <a href="report.html">
      <button>Go to Multi-Report Page</button>
    </a>
  </div>


</div>

<script>
const imgInput = document.getElementById("imgInput");
const btnDetect = document.getElementById("btnDetect");
const detList = document.getElementById("detList");
const annotated = document.getElementById("annotated");

const wrongSection = document.getElementById("wrongSection");
const rightSection = document.getElementById("rightSection");
const todoSection = document.getElementById("todoSection");

let lastFile = null;
imgInput.addEventListener("change", () => {
  lastFile = imgInput.files[0] || null;
  detList.textContent = "—";
  annotated.removeAttribute("src");
});

function createAccordion(title, content, type) {
  const acc = document.createElement("div");
  acc.className = `accordion ${type}`;

  const btn = document.createElement("button");
  btn.textContent = title;
  btn.onclick = () => acc.classList.toggle("active");

  const contentDiv = document.createElement("div");
  contentDiv.className = "accordion-content";
  contentDiv.textContent = content || "";

  acc.appendChild(btn);
  acc.appendChild(contentDiv);
  return acc;
}

btnDetect.addEventListener("click", async () => {
  if (!lastFile) { alert("Please choose an image first."); return; }
  btnDetect.disabled = true; btnDetect.textContent = "Processing…";

  const fd = new FormData();
  fd.append("image", lastFile);
  try {
    const res = await fetch("/detect", { method: "POST", body: fd });
    const data = await res.json();
    if (data.error) throw new Error(data.error);

    // Detections
    detList.textContent = "";
    if (data.detections) {
      data.detections.forEach(d => {
        const span = document.createElement("div");
        span.textContent = `${d.label} (${d.confidence.toFixed(2)})`;
        detList.appendChild(span);
      });
    }
    if (data.annotated_image_b64) {
      annotated.src = `data:image/jpeg;base64,${data.annotated_image_b64}`;
    }

    // Results
    wrongSection.innerHTML = "";
    rightSection.innerHTML = "";
    todoSection.innerHTML = "";

    if (data.wrong) {
      data.wrong.slice(0,10).forEach(item => {
        wrongSection.appendChild(
          createAccordion(
            `Severity ${item.severity} - ${item.heading}`,
            item.explanation,
            "wrong"
          )
        );
      });
    }
    if (data.right) {
      data.right.slice(0,10).forEach(item => {
        rightSection.appendChild(
          createAccordion(item.heading, "", "right")
        );
      });
    }
    if (data.todo) {
      data.todo.slice(0,10).forEach(item => {
        todoSection.appendChild(
          createAccordion(item.heading, "", "todo")
        );
      });
    }

  } catch (err) { alert("Detect failed: " + err.message); }
  finally { btnDetect.disabled = false; btnDetect.textContent = "Run Analysis"; }
});
</script>
</body>
</html>
