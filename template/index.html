<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Safety Vision</title>
  <link rel="preload" href="/static/css/theme.css" as="style">
  <link rel="stylesheet" href="/static/css/theme.css">
  <link rel="stylesheet" href="/static/css/app.css">
  <script defer src="/static/js/app.js"></script>
</head>
</head>
<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>VQA - Home</title>
    <link rel="stylesheet" href="/static/css/theme.css">
    <link rel="stylesheet" href="/static/css/app.css">
  </head>
  <body>
    <header class="site-header">
      <img src="/static/img/logo.svg" alt="logo" height="36">
      <div>
        <div style="font-weight:700">VQA Auditor</div>
        <div style="font-size:13px;color:var(--muted)">Visual QA and Audit</div>
      </div>
      <nav style="margin-left:auto;display:flex;gap:10px;align-items:center;">
        <a href="/" class="button" style="--btn-small:1">Home</a>
        <a href="/audits" class="button" style="background:transparent;color:var(--muted);box-shadow:none;border-radius:10px;padding:8px 10px">Audits</a>
        {% if session.get('user') %}
          <a href="/profile" class="button" style="background:transparent;color:var(--muted);box-shadow:none;padding:8px 10px">{{ session.get('user') }}</a>
          <a href="/auth/logout" class="button">Logout</a>
        {% else %}
          <a href="/auth/login" class="button">Login</a>
        {% endif %}
      </nav>
    </header>
    <main style="max-width:var(--max-width);margin:32px auto;padding:0 18px;">
      <section class="card">
        <h2>Welcome</h2>
        <p>Use the audit tool to generate reports from images.</p>
        <div style="display:flex;gap:12px;align-items:center;">
          <a href="/report" class="button">New Report</a>
          <a href="/multi_report?light=true" class="button">Quick Preview</a>
        </div>
      </section>

      <section style="margin-top:20px;display:grid;grid-template-columns:repeat(auto-fit,minmax(240px,1fr));gap:18px;">
        <div class="card">
          <h3>Recent Audits</h3>
          <p class="muted">No audits yet — run a report to get started.</p>
        </div>
        <div class="card">
          <h3>Tips</h3>
          <ul class="muted">
            <li>Use the Quick Preview on low-bandwidth networks.</li>
            <li>Register to save audit history.</li>
          </ul>
        </div>
      </section>
    </main>
    <script src="/static/js/app.js"></script>
  </body>
</html>
      <h3>What To Do</h3>
      <div id="todoSection"></div>
    </div>
  </div>
  <div style="text-align:center; margin-top:20px;">
    <a href="report.html">
      <button>Go to Multi-Report Page</button>
    </a>
  </div>


</div>

<script>
const imgInput = document.getElementById("imgInput");
const btnDetect = document.getElementById("btnDetect");
const detList = document.getElementById("detList");
const annotated = document.getElementById("annotated");

const wrongSection = document.getElementById("wrongSection");
const rightSection = document.getElementById("rightSection");
const todoSection = document.getElementById("todoSection");

let lastFile = null;
imgInput.addEventListener("change", () => {
  lastFile = imgInput.files[0] || null;
  detList.textContent = "—";
  annotated.removeAttribute("src");
});

function createAccordion(title, content, type) {
  const acc = document.createElement("div");
  acc.className = `accordion ${type}`;

  const btn = document.createElement("button");
  btn.textContent = title;
  btn.onclick = () => acc.classList.toggle("active");

  const contentDiv = document.createElement("div");
  contentDiv.className = "accordion-content";
  contentDiv.textContent = content || "";

  acc.appendChild(btn);
  acc.appendChild(contentDiv);
  return acc;
}

btnDetect.addEventListener("click", async () => {
  if (!lastFile) { alert("Please choose an image first."); return; }
  btnDetect.disabled = true; btnDetect.textContent = "Processing…";

  const fd = new FormData();
  fd.append("image", lastFile);
  try {
    const res = await fetch("/detect", { method: "POST", body: fd });
    const data = await res.json();
    if (data.error) throw new Error(data.error);

    // Detections
    detList.textContent = "";
    if (data.detections) {
      data.detections.forEach(d => {
        const span = document.createElement("div");
        span.textContent = `${d.label} (${d.confidence.toFixed(2)})`;
        detList.appendChild(span);
      });
    }
    if (data.annotated_image_b64) {
      annotated.src = `data:image/jpeg;base64,${data.annotated_image_b64}`;
    }

    // Results
    wrongSection.innerHTML = "";
    rightSection.innerHTML = "";
    todoSection.innerHTML = "";

    if (data.wrong) {
      data.wrong.slice(0,10).forEach(item => {
        wrongSection.appendChild(
          createAccordion(
            `Severity ${item.severity} - ${item.heading}`,
            item.explanation,
            "wrong"
          )
        );
      });
    }
    if (data.right) {
      data.right.slice(0,10).forEach(item => {
        rightSection.appendChild(
          createAccordion(item.heading, "", "right")
        );
      });
    }
    if (data.todo) {
      data.todo.slice(0,10).forEach(item => {
        todoSection.appendChild(
          createAccordion(item.heading, "", "todo")
        );
      });
    }

  } catch (err) { alert("Detect failed: " + err.message); }
  finally { btnDetect.disabled = false; btnDetect.textContent = "Run Analysis"; }
});
</script>
</body>
</html>
