<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Safety Audit Report</title>
  <link rel="preload" href="/static/css/theme.css" as="style">
  <link rel="stylesheet" href="/static/css/theme.css">
  <link rel="stylesheet" href="/static/css/app.css">
  <script defer src="/static/js/app.js"></script>
</head>
</head>
<body>
<a href="/" style="position: absolute; left: 20px; top: 20px; text-decoration: none; color: var(--primary-color); font-size: 2rem;">&#x2190;</a>
<header class="site-header">
  <img src="/static/img/logo.svg" alt="Safety Vision" class="site-logo">
  <div style="flex:1"></div>
  <nav>
    <a class="button" href="/auth/logout">Logout</a>
  </nav>
</header>

<div class="container">
  <div class="card">
    <h3>Generate Multi-Image Report</h3>
    <label>Site Location:</label>
    <input type="text" id="location" placeholder="Enter site location" />
    <label>Audit Start Date:</label>
    <input type="date" id="audit_date" placeholder="Enter Date of Audit" />

    <label>Company Name:</label>
    <input type="text" id="company_name" placeholder="Enter company name" required />

    <label>Site Name:</label>
    <input type="text" id="site_name" placeholder="Enter site name" required />
  

    <label>Upload Images:</label>
    <input type="file" id="images" accept="image/*" multiple />

    <label>Company Logo (optional):</label>
    <input type="file" id="company_logo" accept="image/png, image/jpeg" />

    <!-- <label>Upload Good Practices:</label>
    <input type="file" id="good_practices" accept="image/*" multiple /> -->

    <button id="btnReport">Generate PDF Report</button>
  </div>
</div>

<script>
const btnReport = document.getElementById("btnReport");

btnReport.addEventListener("click", async () => {
  const loc = document.getElementById("location").value.trim();
  const imgs = document.getElementById("images").files;
  if (!loc) { alert("Please enter site location."); return; }
  if (!imgs.length) { alert("Please upload at least one image."); return; }

  btnReport.disabled = true;
  btnReport.textContent = "Generatingâ€¦";

  const fd = new FormData();
  fd.append("location", document.getElementById("location").value);
  fd.append("audit_date", document.getElementById("audit_date").value);
  fd.append("company_name", document.getElementById("company_name").value);
  fd.append("site_name", document.getElementById("site_name").value);

  const logoFile = document.getElementById("company_logo").files[0];
  if (logoFile) {
    fd.append("company_logo", logoFile);
  }

  for (let i = 0; i < imgs.length; i++) {
    fd.append("images", imgs[i]);
  }


  try {
    const res = await fetch("/multi_report", { method: "POST", body: fd });
    if (!res.ok) throw new Error("Report generation failed");

    const blob = await res.blob();
    const url = window.URL.createObjectURL(blob);

    // Auto download PDF
    const a = document.createElement("a");
    a.href = url;
    a.download = "safety_report.pdf";
    document.body.appendChild(a);
    a.click();
    a.remove();
    window.URL.revokeObjectURL(url);

  } catch (err) {
    alert("Error: " + err.message);
  } finally {
    btnReport.disabled = false;
    btnReport.textContent = "Generate PDF Report";
  }
});
</script>

</body>
</html>
